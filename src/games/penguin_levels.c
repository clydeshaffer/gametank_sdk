

#include "./common.h"
#include "./penguin_levels.h"
#include "banking.h"
static char i, r, c, tile;

#pragma rodataseg(push, "PROG0")

static const char half_level_offsets[16] = {
	0x00, 0x0A, 0x14, 0x1F, 0x29, 0x33, 0x3E, 0x47, 0x50, 0x5D, 0x6D, 0x78,
	0x84, 0x91, 0x9E, 0xA8
};

static const char half_level_enc[182] = {
	0x25, 0x29, 0x34, 0x58, 0x5A, 0x78, 0x9C, 0x9E, 0xA0, 0xFF, 0x25, 0x29,
	0x34, 0x58, 0x5A, 0x7E, 0x9A, 0x9C, 0x9E, 0xFF, 0x23, 0x36, 0x38, 0x48,
	0x56, 0x5C, 0x7A, 0x7C, 0x9A, 0xA0, 0xFF, 0x36, 0x38, 0x48, 0x56, 0x5C,
	0x7A, 0x7C, 0x9A, 0xA0, 0xFF, 0x29, 0x48, 0x58, 0x5C, 0x8E, 0x78, 0x7C,
	0x8C, 0xB0, 0xFF, 0x17, 0x23, 0x48, 0x56, 0x5A, 0x68, 0x7A, 0x7E, 0x8C,
	0xAC, 0xFF, 0x34, 0x38, 0x58, 0x5C, 0x78, 0x7C, 0x9C, 0xA0, 0xFF, 0x36,
	0x3A, 0x56, 0x5A, 0x7A, 0x7E, 0x9A, 0x9E, 0xFF, 0x34, 0x36, 0x38, 0x58,
	0x5A, 0x5C, 0x78, 0x7A, 0x7C, 0x9C, 0x9E, 0xA0, 0xFF, 0x25, 0x27, 0x29,
	0x36, 0x38, 0x3A, 0x48, 0x68, 0x6A, 0x6C, 0x8A, 0x8C, 0x8E, 0xAC, 0xB0,
	0xFF, 0x25, 0x29, 0x56, 0x5A, 0x68, 0x6A, 0x6C, 0x9C, 0xA0, 0xAC, 0xFF,
	0x36, 0x3A, 0x68, 0x6A, 0x6C, 0x78, 0x7C, 0xAC, 0xAD, 0xAE, 0xB0, 0xFF,
	0x15, 0x46, 0x4A, 0x58, 0x5A, 0x5C, 0x6A, 0x8A, 0x8C, 0x8E, 0xAC, 0xB0,
	0xFF, 0x17, 0x36, 0x48, 0x56, 0x5A, 0x6B, 0x7A, 0x7C, 0x7E, 0x9A, 0x9C,
	0x9E, 0xFF, 0x25, 0x38, 0x3A, 0x56, 0x58, 0x7C, 0x7E, 0x9A, 0x9C, 0xFF,
	0x25, 0x36, 0x38, 0x3A, 0x56, 0x58, 0x5C, 0x6A, 0x8A, 0x8C, 0x8E, 0xAC,
	0xB0, 0xFF
};

static const char web_offsets[16] = {
	0x00, 0x02, 0x04, 0x08, 0x0C, 0x12, 0x18, 0x20, 0x28, 0x2D, 0x35, 0x3D,
	0x47, 0x53, 0x5F, 0x6A
};

static const char web_enc[115] = {
	0x47, 0xFF, 0x6B, 0xFF, 0x67, 0x8D, 0x4B, 0xFF, 0x45, 0x8B, 0x6D, 0xFF,
	0x45, 0x4B, 0x69, 0x89, 0x8E, 0xFF, 0x45, 0x4B, 0x6B, 0x8A, 0x8F, 0xFF,
	0x67, 0x4B, 0x69, 0x6B, 0x89, 0x8F, 0xAD, 0xFF, 0x45, 0x6D, 0x69, 0x6B,
	0x89, 0x8F, 0xAF, 0xFF, 0x29, 0x45, 0x6D, 0x89, 0xFF, 0x15, 0x46, 0x56,
	0x5A, 0x5C, 0x9C, 0xAE, 0xFF, 0x16, 0x34, 0x47, 0x4B, 0x89, 0x8D, 0xAF,
	0xFF, 0x13, 0x29, 0x45, 0x48, 0x5C, 0x7A, 0x89, 0x8D, 0x8F, 0xFF, 0x16,
	0x23, 0x34, 0x36, 0x3A, 0x45, 0x68, 0x6B, 0x89, 0x8F, 0x9C, 0xFF, 0x15,
	0x29, 0x34, 0x38, 0x4B, 0x58, 0x78, 0x8B, 0x8F, 0xAC, 0xAE, 0xFF, 0x12,
	0x16, 0x48, 0x4B, 0x5A, 0x67, 0x7A, 0x8A, 0xA0, 0xAF, 0xFF, 0x13, 0x17,
	0x47, 0x4B, 0x67, 0x6B, 0x9C, 0x9E, 0xFF
};

static const char default_layout[10] = {
    0b11111111,
    0b10101011,
    0b10101011,
    0b11111111,
    0b10101011,
    0b11111111,
    0b10101011,
    0b11111111,
    0b10101011,
    0b11111111,
};

#pragma rodataseg(pop)

static const char left_half_order[16] = {0x0F,0x00,0x04,0x08,0x0C,0x01,0x05,0x09,0x0D,0x02,0x06,0x0A,0x0E,0x03,0x07,0x0B};

static void load_default_layout(char side, char tilenum) {
    i = 0;
    for(r = 0; r < HALF_LEVEL_HEIGHT; ++r) {
        field[((r+MAZE_OFFSET_ROW) << 4) + 0 + side] = (default_layout[i] & 0b10000000) ? 0 : tilenum;
        field[((r+MAZE_OFFSET_ROW) << 4) + 1 + side] = (default_layout[i] & 0b01000000) ? 0 : tilenum;
        field[((r+MAZE_OFFSET_ROW) << 4) + 2 + side] = (default_layout[i] & 0b00100000) ? 0 : tilenum;
        field[((r+MAZE_OFFSET_ROW) << 4) + 3 + side] = (default_layout[i] & 0b00010000) ? 0 : tilenum;
        field[((r+MAZE_OFFSET_ROW) << 4) + 4 + side] = (default_layout[i] & 0b00001000) ? 0 : tilenum;
        field[((r+MAZE_OFFSET_ROW) << 4) + 5 + side] = (default_layout[i] & 0b00000100) ? 0 : tilenum;
        field[((r+MAZE_OFFSET_ROW) << 4) + 6 + side] = (default_layout[i] & 0b00000010) ? 0 : tilenum;
        i++;
    }
}

static void load_half_level(char* enc, char offset, char side, char tilenum) {
    i = offset;
    while(enc[i] != 0xFF) {

        r = (enc[i] / 17) + 3;
        c = (enc[i] % 17) - 1;

        field[(r << 4) + c + side] = tilenum;
        ++i;
    }
}

#define LEVEL_LEFT_SIDE 0
#define LEVEL_RIGHT_SIDE 8

void load_level_num() {
    change_rom_bank(0xFE);

    tile = 11 + ((level_num & 7) << 5);

    load_default_layout(LEVEL_LEFT_SIDE, tile);
    load_default_layout(LEVEL_RIGHT_SIDE, tile);

    load_half_level(
        half_level_enc,
        half_level_offsets[left_half_order[level_num & 15]],
        LEVEL_LEFT_SIDE,
        tile);
    load_half_level(
        half_level_enc,
        half_level_offsets[0xF & (((level_num) & 0xF) + ((level_num) >> 4))],
        LEVEL_RIGHT_SIDE,
        tile);
    load_half_level(
        web_enc,
        web_offsets[left_half_order[level_num & 15]],
        LEVEL_LEFT_SIDE,
        162);
    load_half_level(
        web_enc,
        web_offsets[0xF & (((level_num) & 0xF) + ((level_num) >> 4))],
        LEVEL_RIGHT_SIDE,
        162);
}